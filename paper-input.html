<link href="../polymer/polymer.html" rel="import">

<polymer-element name="paper-input" attributes="value label floatingLabel" tabindex="0" on-pointerdown="{{pointerdownAction}}" on-pointerup="{{pointerupAction}}" on-blur="{{blurAction}}" on-focus="{{focusAction}}">

  <template>

    <link href="paper-input.css" rel="stylesheet">

    <template if="{{floatingLabel}}">
      <div id="floatedLabel" class="hidden">{{label}}</div>
    </template>

    <span id="inputClone">{{value}}</span>

    <div id="container" on-transitionend="{{transitionEndAction}}" on-webkitTransitionEnd="{{transitionEndAction}}">

      <div id="label">{{label}}</div>

      <input id="input" value="{{value}}">

      <div id="underline"></div>
      <div id="underlineHighlight" class="focusedColor"></div>

      <div id="caret">
        <div id="caretInner" class="focusedColor"></div>
      </div>

    </div>

  </template>

  <script>

    Polymer('paper-input', {

      /**
       * The label for this input. It normally appears as grey text inside
       * the text input and disappears once the user enters text.
       *
       * @attribute label
       * @type string
       * @default ''
       */
      label: '',

      /**
       * If true, the label will "float" above the text input once the
       * user enters text instead of disappearing.
       *
       * @attribute floatingLabel
       * @type boolean
       * @default false
       */
      floatingLabel: false,

      /**
       * The value of this input.
       *
       * @attribute label
       * @type string
       * @default ''
       */
      value: '',

      focused: false,
      pressed: false,

      ready: function() {
        if (this.value) {
          this.$.floatedLabel.classList.remove('hidden');
        }
      },

      focusAction: function(e) {
        if (!this.pressed) {
          if (this.floatingLabel) {
            this.$.floatedLabel.classList.remove('hidden');
            this.$.floatedLabel.classList.add('focused');
            this.$.floatedLabel.classList.add('focusedColor');
          }
          this.$.label.classList.add('hidden');
          this.$.underlineHighlight.classList.add('focused');
          this.$.caret.classList.add('focused');
          this.$.input.focus();
        }
        this.focused = true;
      },

      blurAction: function() {
        this.$.underlineHighlight.classList.remove('focused');
        this.$.caret.classList.remove('focused');
        if (this.floatingLabel) {
          this.$.floatedLabel.classList.remove('focused');
          this.$.floatedLabel.classList.remove('focusedColor');
          if (!this.value) {
            this.$.floatedLabel.classList.add('hidden');
          }
        }
        if (!this.value) {
          this.$.label.classList.remove('hidden');
        }
        this.focused = false;
      },

      pointerdownAction: function(e) {
        if (this.focused) {
          return;
        }
        this.pressed = true;
        var rect = this.$.underline.getBoundingClientRect();
        var right = e.x - rect.left;
        this.$.underlineHighlight.style.webkitTransformOriginX = right + 'px';
        this.$.underlineHighlight.classList.remove('focused');
        this.underlineAsync = this.async(function() {
          this.$.underlineHighlight.classList.add('pressed');
        }, null, 200);
        var width = this.$.inputClone.getBoundingClientRect().width;
        if (width < right) {
          this.$.caret.style.left = width + 'px';
          this.$.caret.classList.remove('focused');
        }
      },

      pointerupAction: function() {
        if (!this.pressed) {
          return;
        }
        if (this.underlineAsync) {
          clearTimeout(this.underlineAsync);
          this.underlineAsync = null;
        }
        this.pressed = false;
        this.$.underlineHighlight.classList.remove('pressed');
        this.$.underlineHighlight.classList.add('animating');
        this.async(function() {
          this.$.underlineHighlight.classList.add('focused');
        });
        this.$.caret.classList.add('animating');
        this.async(function() {
          this.$.caret.classList.add('focused');
        }, null, 100);
        if (this.floatingLabel) {
          this.$.label.classList.add('focusedColor');
          this.$.label.classList.add('animating');
        }
      },

      transitionEndAction: function(e) {
        if (this.pressed) {
          return;
        }
        this.$.label.classList.add('hidden');
        this.$.label.classList.remove('focusedColor');
        if (this.floatingLabel) {
          this.$.label.classList.remove('animating');
          this.$.floatedLabel.classList.remove('hidden');
          this.$.floatedLabel.classList.add('focused');
          this.$.floatedLabel.classList.add('focusedColor');
        }
        this.async(function() {
          this.$.underlineHighlight.classList.remove('animating');
          this.$.caret.classList.remove('animating');
          this.$.input.focus();
        }, null, 100);
      }

    });

  </script>

</polymer-element>