<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../iron-a11y-keys-behavior/iron-a11y-keys-behavior.html">
<link rel="import" href="../../iron-behaviors/iron-control-state.html">

<script>
  Polymer.PaperInputBehaviorTinyImpl = {
    properties: {
      /**
       * Fired when the input changes due to user interaction.
       *
       * @event change
       */

      /**
       * The label for this input. Bind this to `<paper-input-container>`'s `label` property.
       */
      label: {
        type: String
      },

      /**
       * The value for this input. Bind this to the `<input is="iron-input">`'s `bindValue`
       * property, or the value property of your input that is `notify:true`.
       */
      value: {
        notify: true,
        type: String
      },

      /**
       * Set to true to disable this input. If you're using PaperInputBehavior to
       * implement your own paper-input-like element, bind this to
       * both the `<paper-input-container>`'s and the input's `disabled` property.
       */
      disabled: {
        type: Boolean,
        value: false
      },

      /**
       * Set to true to disable the floating label. Bind this to the `<paper-input-container>`'s
       * `noLabelFloat` property.
       */
      noLabelFloat: {
        type: Boolean,
        value: false
      },

      /**
       * Set to true to always float the label. Bind this to the `<paper-input-container>`'s
       * `alwaysFloatLabel` property.
       */
      alwaysFloatLabel: {
        type: Boolean,
        value: false
      }
    },

    _computeAlwaysFloatLabel: function(alwaysFloatLabel, placeholder) {
      return placeholder || alwaysFloatLabel;
    },

    _onChange:function(event) {
      // In the Shadow DOM, the `change` event is not leaked into the
      // ancestor tree, so we must do this manually.
      // See https://w3c.github.io/webcomponents/spec/shadow/#events-that-are-not-leaked-into-ancestor-trees.
      if (this.shadowRoot) {
        this.fire(event.type, {sourceEvent: event}, {
          node: this,
          bubbles: event.bubbles,
          cancelable: event.cancelable
        });
      }
    }
  };

  Polymer.PaperInputBehaviorUIImpl = {
    attached: function() {
      this.addEventListener('input', this._onInput);
      this._onInput();
    },

    _onInput: function() {
      var value = this.$.input.value;
      if (value || value === 0 || (!!this.placeholder && !this.value)) {
        this._hasContent = true;
      } else {
        this._hasContent = false;
      }
    },

    _computeLabelClass: function(noLabelFloat,alwaysFloatLabel,focused,hasContent,invalid) {
      var cls = '';
      if (noLabelFloat === true) {
        return hasContent ? 'label-is-hidden' : '';
      }

      if (hasContent || alwaysFloatLabel === true) {
        cls += ' label-is-floating';
        if (invalid) {
          cls += ' is-invalid';
        } else if (focused) {
          cls += " label-is-highlighted";
        }
      }

      return cls;
    },

    _computeUnderlineClass: function(focused,invalid) {
      var cls = 'underline';
      if (invalid) {
        cls += ' is-invalid';
      } else if (focused) {
        cls += ' is-highlighted'
      }
      return cls;
    }
  };

  Polymer.PaperInputBehaviorValidationImpl = {
    properties: {
      /**
       * Returns true if the value is invalid. Bind this to both the `<paper-input-container>`'s
       * and the input's `invalid` property.
       */
      invalid: {
        type: Boolean,
        value: false,
        notify: true
      },

      /**
       * Set to true to auto-validate the input value. Bind this to the `<paper-input-container>`'s
       * `autoValidate` property.
       */
      autoValidate: {
        type: Boolean,
        value: false
      },

      /**
       * A pattern to validate the `input` with. Bind this to the `<input is="iron-input">`'s
       * `pattern` property.
       */
      pattern: {
        type: String
      },

      /**
       * The error message to display when the input is invalid. Bind this to the
       * `<paper-input-error>`'s content, if using.
       */
      errorMessage: {
        type: String
      },

      /**
       * Set to true to mark the input as required. Bind this to the `<input is="iron-input">`'s
       * `required` property.
       */
      required: {
        type: Boolean,
        value: false
      },

      /**
       * Set this to specify the pattern allowed by `preventInvalidInput`. Bind this to the
       * `<input is="iron-input">`'s `allowedPattern` property.
       */
      allowedPattern: {
        type: String
      },

      /**
       * Set to true to prevent the user from entering invalid input. Bind this to the
       * `<input is="iron-input">`'s `preventInvalidInput` property.
       */
      preventInvalidInput: {
        type: Boolean
      },

      /**
       * Name of the validator to use. If you're using PaperInputBehavior to
       * implement your own paper-input-like element, bind this to
       * the `<input is="iron-input">`'s `validator` property.
       */
      // validator: {
      //   type: String
      // },
    },

    ready: function() {
      this.addEventListener('focus', this._boundOnFocus, true);
      this.addEventListener('blur', this._boundOnBlur, true);
    },

    attached: function() {
      // Only validate when attached if the input already has a value.
      if (this.$.input.value != '') {
        this._handleValueAndAutoValidate();
      } else {
        this._onInput();
      }
    },

    _onFocus: function() {
      this._setFocused(true);
    },

    _onBlur: function() {
      this._setFocused(false);
      this._handleValueAndAutoValidate();
    },

    _onValueChanged: function(event) {
      debugger
      this._handleValueAndAutoValidate();
    },

    _onInput: function() {
      var value = this.$.input.value;
      if (value || value === 0 || (!!this.placeholder && !this.value)) {
        this._hasContent = true;
      } else {
        this._hasContent = false;
      }
      this._handleValueAndAutoValidate();
    },

    _handleValueAndAutoValidate: function() {
      if (this.autoValidate) {
        var valid;
        if (this.$.input.validate) {
          valid = this.$.input.validate();
        } else {
          valid = this.$.input.checkValidity();
        }
        this.invalid = !valid;
      }
    },
    /**
     * Validates the input element and sets an error style if needed.
     *
     * @return {boolean}
     */
    validate: function() {
      return this.$.input.validate();
    },

    /**
     * If `autoValidate` is true, then validates the element.
     */
    _handleAutoValidate: function() {
      if (this.autoValidate)
        this.validate();
    }
  };


  // Things we have:
  // PaperInputBehaviorTinyImpl
  // PaperInputBehaviorValidationImpl
  // PaperInputBehaviorUIImpl

  /** @polymerBehavior */
  Polymer.PaperInputBehaviorBasicImpl = [Polymer.IronControlState,
                                         Polymer.IronA11yKeysBehavior];

  Polymer.PaperInputBehaviorTiny = [Polymer.PaperInputBehaviorBasicImpl,
                                    Polymer.PaperInputBehaviorTinyImpl];

  // Polymer.PaperInputNotAnInputBehavior = [Polymer.PaperInputBehaviorCustomInputProperties,
  //                                         Polymer.PaperInputBehaviorLightImpl,
  //                                         Polymer.PaperInputBehaviorLightImpl,
  //
  //                                         Polymer.PaperInputBehaviorAdvancedValidationProperties,
  //                                       //  PaperInputBehaviorAdvancedValidationLogic
  //                                         ];
</script>
